<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8"/>
<title>Safe 在线聚合器（构造 / 验签 / 聚合 / 提交）· 多帧二维码</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
  :root{--fg:#111827;--muted:#6b7280;--br:#e5e7eb;--ok:#16a34a;--bad:#dc2626;--accent:#111; --scan-size:min(85vmin,720px);}
  body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:24px;max-width:1080px;color:var(--fg)}
  h1{font-size:22px;margin:0 0 12px}
  .card{border:1px solid var(--br);border-radius:12px;padding:16px;margin:16px 0}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  label{display:block}
  input,textarea,button{font-size:14px}
  input[type=text],input[type=number],textarea{width:100%;padding:10px;border:1px solid var(--br);border-radius:10px;font-family:monospace}
  textarea{min-height:120px}
  button{padding:10px 14px;border-radius:10px;border:1px solid var(--accent);background:var(--accent);color:#fff;cursor:pointer}
  button.ghost{background:#fff;color:var(--accent)}
  .muted{color:var(--muted)}
  .mono{font-family:monospace}
  .ok{color:var(--ok);font-weight:700}
  .bad{color:var(--bad);font-weight:700}
  .hidden{display:none}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid var(--br);text-align:left}
  .pill{display:inline-block;padding:2px 8px;border-radius:9999px;background:#eef2ff;color:#4338ca;font-size:12px}
  .qrdeck{display:flex;flex-direction:column;align-items:center;gap:6px}
  .qrdeck .frame{width:280px;height:280px}
  .qrdeck .controls{display:flex;gap:8px;align-items:center}

  /* 摄像头扫码UI */
  .cam-wrap{position:relative;border:1px solid var(--br);border-radius:12px;overflow:hidden;background:#000;margin-top:10px}
  .cam-wrap .preview{position:relative;width:100%;height:80vh;max-height:92vh;min-height:320px}
  .cam-wrap video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
  .cam-wrap canvas{display:none}
  .scan-overlay{pointer-events:none;position:absolute;inset:0;display:flex;align-items:center;justify-content:center}
  .scan-overlay::before{
    content:"";display:block;width:var(--scan-size);aspect-ratio:1/1;border:2px solid rgba(255,255,255,.95);border-radius:16px;
    box-shadow:0 0 0 9999px rgba(0,0,0,.35);
  }
  .hint{position:absolute;bottom:10px;left:0;right:0;text-align:center;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,.6);font-size:14px}
</style>
</head>
<body>
<h1>Safe 在线聚合器（构造 / 验签 / 聚合 / 提交）</h1>

<!-- 全局 / 网络 -->
<div class="card">
  <h2>全局 / 网络</h2>
  <div class="grid">
    <label>RPC_URL_1 <input id="rpc1" type="text" placeholder="https://mainnet.infura.io/v3/..." /></label>
    <label>RPC_URL_2 <input id="rpc2" type="text" placeholder="https://eth-mainnet.g.alchemy.com/v2/..." /></label>
  </div>
  <div class="row">
    <label style="flex:1">Safe 地址<input id="safe_addr" type="text" placeholder="0xYourSafe"/></label>
    <button id="btn_load" class="ghost">读取 Safe 信息</button>
    <span id="net_status" class="muted"></span>
  </div>
  <pre id="safe_info" class="mono muted"></pre>
</div>

<!-- 构造调用 & 估算 safeTxGas -->
<div class="card">
  <h2>构造调用 & 估算 safeTxGas</h2>
  <div class="row">
    <label class="inline"><input type="radio" name="kind" value="ETH" checked/> ETH</label>
    <label class="inline"><input type="radio" name="kind" value="ERC20"/> ERC-20</label>
  </div>
  <div id="eth_box" class="grid">
    <label>to<input id="eth_to" type="text" placeholder="0xRecipient"/></label>
    <label>amount(ETH)<input id="eth_amount" type="text" placeholder="1.0"/></label>
  </div>
  <div id="erc_box" class="grid hidden">
    <label>token<input id="erc_token" type="text" placeholder="0xToken"/></label>
    <label>to<input id="erc_to" type="text" placeholder="0xRecipient"/></label>
    <label>amount(human)<input id="erc_amount" type="text" placeholder="1000"/></label>
    <label>decimals<input id="erc_decimals" type="number" value="18" min="0" max="36"/></label>
  </div>

  <div class="grid3">
    <label>operation<input id="op" type="number" value="0" min="0" max="1"/></label>
    <label>safeTxGas<input id="safeTxGas" type="number" value="0"/></label>
    <label>baseGas<input id="baseGas" type="number" value="0"/></label>
    <label>gasPrice<input id="gasPrice" type="number" value="0"/></label>
    <label>gasToken<input id="gasToken" type="text" value="0x0000000000000000000000000000000000000000"/></label>
    <label>refundReceiver<input id="refundReceiver" type="text" value="0x0000000000000000000000000000000000000000"/></label>
  </div>

  <div class="row">
    <label>Safe Nonce<input id="nonce" type="number" value="0" style="width:160px"/></label>
    <button id="btn_refresh_nonce" class="ghost">刷新 Nonce</button>
    <button id="btn_estimate" class="ghost">估算 safeTxGas</button>
    <span id="build_status" class="muted"></span>
  </div>

  <div class="row">
    <button id="btn_build_712">生成 EIP-712 JSON（二维码）</button>
    <span class="muted">发给各 owner 用离线端签名</span>
  </div>
  <div class="grid">
    <label>EIP-712 JSON<textarea id="typed_json" readonly></textarea></label>
    <label>safeTxHash<textarea id="typed_hash" readonly></textarea></label>
  </div>
  <div class="row"><div><div class="muted">EIP-712 JSON 二维码</div><div id="qr_typed" style="margin-top:6px"></div></div></div>
</div>

<!-- EIP-1559 Gas 估算 -->
<div class="card">
  <h2>EIP-1559 Gas 估算（低/中/高） <span id="gas_applied" class="pill hidden">已应用：<span id="gas_choice"></span></span></h2>
  <div class="row">
    <button id="btn_gas_est" class="ghost">估算当前 Gas 档位</button>
    <span id="gas_status" class="muted"></span>
  </div>
  <div id="gas_table_box" style="margin-top:10px"></div>
</div>

<!-- 收集 / 验签 / 聚合 -->
<div class="card">
  <h2>收集 / 验签 / 聚合</h2>
  <div class="row">
    <button id="btn_scan_sig" class="ghost">扫码签名</button>
    <input id="sig_hex" type="text" placeholder="0x...签名hex（65字节）" style="flex:1"/>
    <button id="btn_add_sig">添加签名</button>
    <span id="sig_status" class="muted"></span>
  </div>

  <div id="cam_box" class="card" style="display:none">
    <div class="row"><button id="stop_scan" class="ghost">停止扫码</button><span id="scan_status" class="muted"></span></div>
    <div class="cam-wrap">
      <div class="preview">
        <video id="video" playsinline webkit-playsinline muted></video>
        <canvas id="canvas"></canvas>
        <div class="scan-overlay"></div>
        <div class="hint">请将二维码置于白色框内</div>
      </div>
    </div>
  </div>

  <div id="sigs_table_box" style="margin-top:12px"></div>

  <div class="row">
    <button id="btn_assemble">聚合并编码 execTransaction</button>
    <span id="asm_status" class="muted"></span>
  </div>
  <label>calldata<textarea id="calldata" readonly></textarea></label>
</div>

<!-- 提交者 tx_human.json & 动态二维码 -->
<div class="card">
  <h2>提交者 tx_human.json & 动态二维码</h2>

  <div class="row" style="gap:8px">
    <button id="btn_build_json" class="ghost">① 从 calldata 生成 tx_human.json</button>
    <button id="btn_make_safeqr" class="ghost">② 从 tx_human.json 生成 SAFEQR（循环）</button>
    <button id="btn_copy_json" class="ghost">复制 JSON</button>
    <button id="btn_download_json" class="ghost">下载 JSON 文件</button>
    <span id="submit_status" class="muted"></span>
  </div>

  <!-- 新增：提交者EOA输入，用于查询nonce与估gas -->
  <div class="row" style="gap:8px">
    <label style="flex:1">提交者 EOA 地址
      <input id="sender_eoa" type="text" placeholder="0x 提交者外层交易地址，用于查询 nonce / 估 gas"/>
    </label>
  </div>

  <div class="row" style="gap:8px">
    <label style="max-width:220px">每帧最大字节<input id="qr_chunk" type="number" value="900" min="200" max="2000"/></label>
    <label style="max-width:220px">播放间隔(ms)<input id="qr_interval" type="number" value="700" min="200" step="50"/></label>
  </div>

  <div class="qrdeck">
    <div id="qr_submit" class="frame"></div>
    <div id="qr_nav" class="controls hidden">
      <button id="qr_prev" class="ghost">上一帧</button>
      <span id="qr_info" class="muted">0 / 0</span>
      <button id="qr_next" class="ghost">下一帧</button>
      <button id="qr_pause" class="ghost">暂停</button>
      <button id="qr_play" class="ghost hidden">继续</button>
      <button id="btn_copy_qr_one" class="ghost">复制当前帧</button>
      <button id="btn_copy_qr_all" class="ghost">复制全部帧</button>
    </div>
  </div>

  <label>RawTx<input id="rawtx" type="text" placeholder="0x..."/></label>
  <div class="row">
    <button id="btn_broadcast">双 RPC 广播</button>
    <span id="bc_status" class="muted"></span>
  </div>
  <div id="bc_table_box" style="margin-top:12px"></div>
</div>

<!-- 工具 -->
<div class="card">
  <h2>工具：查询地址 Nonce / 打开区块链浏览器</h2>
  <div class="row" style="gap:8px">
    <input id="addr" type="text" placeholder="0x 地址" style="flex:1"/>
    <button id="btn_get_nonce" class="ghost">查询 pending nonce</button>
    <button id="btn_open_addr" class="ghost">打开浏览器</button>
    <span id="aux_status" class="muted"></span>
  </div>
  <div id="nonce_table_box" style="margin-top:12px"></div>
</div>

<!-- 第三方库 -->
<script src="./libs/ethers.umd.min.js"></script>
<script src="./libs/qrcode.min.js"></script>
<script src="./libs/jsQR.js"></script>

<!-- 业务代码 -->
<script src="./js/abi.js"></script>
<script src="./js/app.js"></script>
</body>
</html>
